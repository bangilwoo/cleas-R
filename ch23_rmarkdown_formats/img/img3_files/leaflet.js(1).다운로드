(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _util=require("./util");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var ClusterLayerStore=function(){function ClusterLayerStore(group){_classCallCheck(this,ClusterLayerStore);this._layers={};this._group=group}_createClass(ClusterLayerStore,[{key:"add",value:function add(layer,id){if(typeof id!=="undefined"&&id!==null){if(this._layers[id]){this._group.removeLayer(this._layers[id])}this._layers[id]=layer}this._group.addLayer(layer)}},{key:"remove",value:function remove(id){if(typeof id==="undefined"||id===null){return}id=(0,_util.asArray)(id);for(var i=0;i<id.length;i++){if(this._layers[id[i]]){this._group.removeLayer(this._layers[id[i]]);delete this._layers[id[i]]}}}},{key:"clear",value:function clear(){this._layers={};this._group.clearLayers()}}]);return ClusterLayerStore}();exports.default=ClusterLayerStore},{"./util":17}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var ControlStore=function(){function ControlStore(map){_classCallCheck(this,ControlStore);this._controlsNoId=[];this._controlsById={};this._map=map}_createClass(ControlStore,[{key:"add",value:function add(control,id,html){if(typeof id!=="undefined"&&id!==null){if(this._controlsById[id]){this._map.removeControl(this._controlsById[id])}this._controlsById[id]=control}else{this._controlsNoId.push(control)}this._map.addControl(control)}},{key:"get",value:function get(id){var control=null;if(this._controlsById[id]){control=this._controlsById[id]}return control}},{key:"remove",value:function remove(id){if(this._controlsById[id]){var control=this._controlsById[id];this._map.removeControl(control);delete this._controlsById[id]}}},{key:"clear",value:function clear(){for(var i=0;i<this._controlsNoId.length;i++){var control=this._controlsNoId[i];this._map.removeControl(control)}this._controlsNoId=[];for(var key in this._controlsById){var _control=this._controlsById[key];this._map.removeControl(_control)}this._controlsById={}}}]);return ControlStore}();exports.default=ControlStore},{}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.getCRS=getCRS;var _leaflet=require("./global/leaflet");var _leaflet2=_interopRequireDefault(_leaflet);var _proj4leaflet=require("./global/proj4leaflet");var _proj4leaflet2=_interopRequireDefault(_proj4leaflet);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function getCRS(crsOptions){var crs=_leaflet2.default.CRS.EPSG3857;switch(crsOptions.crsClass){case"L.CRS.EPSG3857":crs=_leaflet2.default.CRS.EPSG3857;break;case"L.CRS.EPSG4326":crs=_leaflet2.default.CRS.EPSG4326;break;case"L.CRS.EPSG3395":crs=_leaflet2.default.CRS.EPSG3395;break;case"L.CRS.Simple":crs=_leaflet2.default.CRS.Simple;break;case"L.Proj.CRS":if(crsOptions.options&&crsOptions.options.bounds){crsOptions.options.bounds=_leaflet2.default.bounds(crsOptions.options.bounds)}if(crsOptions.options&&crsOptions.options.transformation){crsOptions.options.transformation=new _leaflet2.default.Transformation(crsOptions.options.transformation[0],crsOptions.options.transformation[1],crsOptions.options.transformation[2],crsOptions.options.transformation[3])}crs=new _proj4leaflet2.default.CRS(crsOptions.code,crsOptions.proj4def,crsOptions.options);break;case"L.Proj.CRS.TMS":if(crsOptions.options&&crsOptions.options.bounds){crsOptions.options.bounds=_leaflet2.default.bounds(crsOptions.options.bounds)}if(crsOptions.options&&crsOptions.options.transformation){crsOptions.options.transformation=_leaflet2.default.Transformation(crsOptions.options.transformation[0],crsOptions.options.transformation[1],crsOptions.options.transformation[2],crsOptions.options.transformation[3])}crs=new _proj4leaflet2.default.CRS(crsOptions.code,crsOptions.proj4def,crsOptions.options);break}return crs}},{"./global/leaflet":10,"./global/proj4leaflet":11}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _util=require("./util");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var DataFrame=function(){function DataFrame(){_classCallCheck(this,DataFrame);this.columns=[];this.colnames=[];this.colstrict=[];this.effectiveLength=0;this.colindices={}}_createClass(DataFrame,[{key:"_updateCachedProperties",value:function _updateCachedProperties(){var _this=this;this.effectiveLength=0;this.colindices={};this.columns.forEach(function(column,i){_this.effectiveLength=Math.max(_this.effectiveLength,column.length);_this.colindices[_this.colnames[i]]=i})}},{key:"_colIndex",value:function _colIndex(colname){var index=this.colindices[colname];if(typeof index==="undefined")return-1;return index}},{key:"col",value:function col(name,values,strict){if(typeof name!=="string")throw new Error('Invalid column name "'+name+'"');var index=this._colIndex(name);if(arguments.length===1){if(index<0)return null;else return(0,_util.recycle)(this.columns[index],this.effectiveLength)}if(index<0){index=this.colnames.length;this.colnames.push(name)}this.columns[index]=(0,_util.asArray)(values);this.colstrict[index]=!!strict;this._updateCachedProperties();return this}},{key:"cbind",value:function cbind(obj,strict){var _this2=this;Object.keys(obj).forEach(function(name){var coldata=obj[name];_this2.col(name,coldata)});return this}},{key:"get",value:function get(row,col,missingOK){var _this3=this;if(row>this.effectiveLength)throw new Error("Row argument was out of bounds: "+row+" > "+this.effectiveLength);var colIndex=-1;if(typeof col==="undefined"){var rowData={};this.colnames.forEach(function(name,i){rowData[name]=_this3.columns[i][row%_this3.columns[i].length]});return rowData}else if(typeof col==="string"){colIndex=this._colIndex(col)}else if(typeof col==="number"){colIndex=col}if(colIndex<0||colIndex>this.columns.length){if(missingOK)return void 0;else throw new Error("Unknown column index: "+col)}return this.columns[colIndex][row%this.columns[colIndex].length]}},{key:"nrow",value:function nrow(){return this.effectiveLength}}]);return DataFrame}();exports.default=DataFrame},{"./util":17}],5:[function(require,module,exports){"use strict";var _leaflet=require("./global/leaflet");var _leaflet2=_interopRequireDefault(_leaflet);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}if(typeof _leaflet2.default.Icon.Default.imagePath==="undefined"){switch(window.location.protocol){case"http:":_leaflet2.default.Icon.Default.imagePath="http://cdn.leafletjs.com/leaflet/v1.3.1/images/";break;default:_leaflet2.default.Icon.Default.imagePath="https://unpkg.com/leaflet@1.3.1/dist/images/";break}}},{"./global/leaflet":10}],6:[function(require,module,exports){"use strict";var _leaflet=require("./global/leaflet");var _leaflet2=_interopRequireDefault(_leaflet);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}_leaflet2.default.Tooltip.prototype.options.textsize="10px";_leaflet2.default.Tooltip.prototype.options.textOnly=false;_leaflet2.default.Tooltip.prototype.options.style=null;var initLayoutOriginal=_leaflet2.default.Tooltip.prototype._initLayout;_leaflet2.default.Tooltip.prototype._initLayout=function(){initLayoutOriginal.call(this);this._container.style.fontSize=this.options.textsize;if(this.options.textOnly){_leaflet2.default.DomUtil.addClass(this._container,"leaflet-tooltip-text-only")}if(this.options.style){for(var property in this.options.style){this._container.style[property]=this.options.style[property]}}}},{"./global/leaflet":10}],7:[function(require,module,exports){"use strict";var _leaflet=require("./global/leaflet");var _leaflet2=_interopRequireDefault(_leaflet);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var protocolRegex=/^\/\//;var upgrade_protocol=function upgrade_protocol(urlTemplate){if(protocolRegex.test(urlTemplate)){if(window.location.protocol==="file:"){urlTemplate="http:"+urlTemplate}}return urlTemplate};var originalLTileLayerInitialize=_leaflet2.default.TileLayer.prototype.initialize;_leaflet2.default.TileLayer.prototype.initialize=function(urlTemplate,options){urlTemplate=upgrade_protocol(urlTemplate);originalLTileLayerInitialize.call(this,urlTemplate,options)};var originalLTileLayerWMSInitialize=_leaflet2.default.TileLayer.WMS.prototype.initialize;_leaflet2.default.TileLayer.WMS.prototype.initialize=function(urlTemplate,options){urlTemplate=upgrade_protocol(urlTemplate);originalLTileLayerWMSInitialize.call(this,urlTemplate,options)}},{"./global/leaflet":10}],8:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=global.HTMLWidgets}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],9:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=global.jQuery}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],10:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=global.L}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],11:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=global.L.Proj}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],12:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=global.Shiny}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],13:[function(require,module,exports){"use strict";var _jquery=require("./global/jquery");var _jquery2=_interopRequireDefault(_jquery);var _leaflet=require("./global/leaflet");var _leaflet2=_interopRequireDefault(_leaflet);var _shiny=require("./global/shiny");var _shiny2=_interopRequireDefault(_shiny);var _htmlwidgets=require("./global/htmlwidgets");var _htmlwidgets2=_interopRequireDefault(_htmlwidgets);var _util=require("./util");var _crs_utils=require("./crs_utils");var _controlStore=require("./control-store");var _controlStore2=_interopRequireDefault(_controlStore);var _layerManager=require("./layer-manager");var _layerManager2=_interopRequireDefault(_layerManager);var _methods=require("./methods");var _methods2=_interopRequireDefault(_methods);require("./fixup-default-icon");require("./fixup-default-tooltip");require("./fixup-url-protocol");var _dataframe=require("./dataframe");var _dataframe2=_interopRequireDefault(_dataframe);var _clusterLayerStore=require("./cluster-layer-store");var _clusterLayerStore2=_interopRequireDefault(_clusterLayerStore);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}window.LeafletWidget={};window.LeafletWidget.utils={};var methods=window.LeafletWidget.methods=_jquery2.default.extend({},_methods2.default);window.LeafletWidget.DataFrame=_dataframe2.default;window.LeafletWidget.ClusterLayerStore=_clusterLayerStore2.default;window.LeafletWidget.utils.getCRS=_crs_utils.getCRS;function updateBounds(map){var id=map.getContainer().id;var bounds=map.getBounds();_shiny2.default.onInputChange(id+"_bounds",{north:bounds.getNorthEast().lat,east:bounds.getNorthEast().lng,south:bounds.getSouthWest().lat,west:bounds.getSouthWest().lng});_shiny2.default.onInputChange(id+"_center",{lng:map.getCenter().lng,lat:map.getCenter().lat});_shiny2.default.onInputChange(id+"_zoom",map.getZoom())}function preventUnintendedZoomOnScroll(map){var lastScreen={x:null,y:null};(0,_jquery2.default)(document).on("mousewheel DOMMouseScroll","*",function(e){map.scrollWheelZoom.disable();lastScreen={x:e.originalEvent.screenX,y:e.originalEvent.screenY}});(0,_jquery2.default)(document).on("mousemove","*",function(e){if(lastScreen.x!==null&&e.screenX!==lastScreen.x||e.screenY!==lastScreen.y){map.scrollWheelZoom.enable();lastScreen={x:null,y:null}}});(0,_jquery2.default)(document).on("mousedown",".leaflet",function(e){map.scrollWheelZoom.enable();lastScreen={x:null,y:null}})}_htmlwidgets2.default.widget({name:"leaflet",type:"output",factory:function factory(el,width,height){var map=null;return{getMap:function getMap(){return map},renderValue:function renderValue(data){if(data&&data.options&&data.options.crs){data.options.crs=(0,_crs_utils.getCRS)(data.options.crs)}if(map){map.remove();map=function(){return}()}if(data.options.mapFactory&&typeof data.options.mapFactory==="function"){map=data.options.mapFactory(el,data.options)}else{map=_leaflet2.default.map(el,data.options)}preventUnintendedZoomOnScroll(map);map.leafletr={hasRendered:false,pendingRenderData:null};if(_htmlwidgets2.default.shinyMode&&/\bshiny-bound-output\b/.test(el.className)){map.id=el.id;(0,_jquery2.default)(el).data("leaflet-map",map);map.on("click",function(e){_shiny2.default.onInputChange(map.id+"_click",{lat:e.latlng.lat,lng:e.latlng.lng,".nonce":Math.random()})});var groupTimerId=null;map.on("moveend",function(e){updateBounds(e.target)}).on("layeradd layerremove",function(e){if(map.layerManager.getGroupNameFromLayerGroup(e.layer)){if(groupTimerId){clearTimeout(groupTimerId);groupTimerId=null}groupTimerId=setTimeout(function(){groupTimerId=null;_shiny2.default.onInputChange(map.id+"_groups",map.layerManager.getVisibleGroups())},100)}})}this.doRenderValue(data,map)},doRenderValue:function doRenderValue(data,map){if(el.offsetWidth===0||el.offsetHeight===0){map.leafletr.pendingRenderData=data;return}map.leafletr.pendingRenderData=null;var options=_jquery2.default.extend({zoomToLimits:"always"},data.options);if(!map.layerManager){map.controls=new _controlStore2.default(map);map.layerManager=new _layerManager2.default(map)}else{map.controls.clear();map.layerManager.clear()}var explicitView=false;if(data.setView){explicitView=true;map.setView.apply(map,data.setView)}if(data.fitBounds){explicitView=true;methods.fitBounds.apply(map,data.fitBounds)}if(data.flyTo){if(!explicitView&&!map.leafletr.hasRendered){map.fitWorld()}explicitView=true;map.flyTo.apply(map,data.flyTo)}if(data.flyToBounds){if(!explicitView&&!map.leafletr.hasRendered){map.fitWorld()}explicitView=true;methods.flyToBounds.apply(map,data.flyToBounds)}if(data.options.center){explicitView=true}function needsZoom(){return options.zoomToLimits==="always"||options.zoomToLimits==="first"&&!map.leafletr.hasRendered}if(!explicitView&&needsZoom()&&!map.getZoom()){if(data.limits&&!_jquery2.default.isEmptyObject(data.limits)){var pad=.006;if(data.limits.lat[0]===data.limits.lat[1]){data.limits.lat[0]=data.limits.lat[0]-pad;data.limits.lat[1]=data.limits.lat[1]+pad}if(data.limits.lng[0]===data.limits.lng[1]){data.limits.lng[0]=data.limits.lng[0]-pad;data.limits.lng[1]=data.limits.lng[1]+pad}map.fitBounds([[data.limits.lat[0],data.limits.lng[0]],[data.limits.lat[1],data.limits.lng[1]]])}else{map.fitWorld()}}for(var i=0;data.calls&&i<data.calls.length;i++){var call=data.calls[i];if(methods[call.method])methods[call.method].apply(map,call.args);else(0,_util.log)("Unknown method "+call.method)}map.leafletr.hasRendered=true;if(_htmlwidgets2.default.shinyMode){setTimeout(function(){updateBounds(map)},1)}},resize:function resize(width,height){if(map){map.invalidateSize();if(map.leafletr.pendingRenderData){this.doRenderValue(map.leafletr.pendingRenderData,map)}}}}}});if(_htmlwidgets2.default.shinyMode){_shiny2.default.addCustomMessageHandler("leaflet-calls",function(data){var id=data.id;var el=document.getElementById(id);var map=el?(0,_jquery2.default)(el).data("leaflet-map"):null;if(!map){(0,_util.log)("Couldn't find map with id "+id);return}for(var i=0;i<data.calls.length;i++){var call=data.calls[i];if(call.dependencies){_shiny2.default.renderDependencies(call.dependencies)}if(methods[call.method])methods[call.method].apply(map,call.args);else(0,_util.log)("Unknown method "+call.method)}})}},{"./cluster-layer-store":1,"./control-store":2,"./crs_utils":3,"./dataframe":4,"./fixup-default-icon":5,"./fixup-default-tooltip":6,"./fixup-url-protocol":7,"./global/htmlwidgets":8,"./global/jquery":9,"./global/leaflet":10,"./global/shiny":12,"./layer-manager":14,"./methods":15,"./util":17}],14:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _jquery=require("./global/jquery");var _jquery2=_interopRequireDefault(_jquery);var _leaflet=require("./global/leaflet");var _leaflet2=_interopRequireDefault(_leaflet);var _util=require("./util");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var LayerManager=function(){function LayerManager(map){_classCallCheck(this,LayerManager);this._map=map;this._byGroup={};this._byCategory={};this._byLayerId={};this._byStamp={};this._byCrosstalkGroup={};this._categoryContainers={};this._groupContainers={}}_createClass(LayerManager,[{key:"addLayer",value:function addLayer(layer,category,layerId,group,ctGroup,ctKey){var _this=this;var hasId=typeof layerId==="string";var grouped=typeof group==="string";var stamp=_leaflet2.default.Util.stamp(layer)+"";var container=this._categoryContainers[category]=this._categoryContainers[category]||_leaflet2.default.layerGroup().addTo(this._map);var oldLayer=null;if(hasId){var prefixedLayerId=this._layerIdKey(category,layerId);oldLayer=this._byLayerId[prefixedLayerId];if(oldLayer){this._removeLayer(oldLayer)}this._byLayerId[prefixedLayerId]=layer}if(grouped){this._byGroup[group]=this._byGroup[group]||{};this._byGroup[group][stamp]=layer;container=this.getLayerGroup(group,true)}this._byCategory[category]=this._byCategory[category]||{};this._byCategory[category][stamp]=layer;var layerInfo=this._byStamp[stamp]={layer:layer,group:group,ctGroup:ctGroup,ctKey:ctKey,layerId:layerId,category:category,container:container,hidden:false};if(ctGroup){if(layer.setStyle){layer.options.origOpacity=typeof layer.options.opacity!=="undefined"?layer.options.opacity:.5;layer.options.origFillOpacity=typeof layer.options.fillOpacity!=="undefined"?layer.options.fillOpacity:.2}var ctg=this._byCrosstalkGroup[ctGroup];if(!ctg){ctg=this._byCrosstalkGroup[ctGroup]={};var crosstalk=global.crosstalk;var handleFilter=function handleFilter(e){if(!e.value){var groupKeys=Object.keys(ctg);for(var i=0;i<groupKeys.length;i++){var key=groupKeys[i];var _layerInfo=_this._byStamp[ctg[key]];_this._setVisibility(_layerInfo,true)}}else{var selectedKeys={};for(var _i=0;_i<e.value.length;_i++){selectedKeys[e.value[_i]]=true}var _groupKeys=Object.keys(ctg);for(var _i2=0;_i2<_groupKeys.length;_i2++){var _key=_groupKeys[_i2];var _layerInfo2=_this._byStamp[ctg[_key]];_this._setVisibility(_layerInfo2,selectedKeys[_groupKeys[_i2]])}}};var filterHandle=new crosstalk.FilterHandle(ctGroup);filterHandle.on("change",handleFilter);var handleSelection=function handleSelection(e){if(!e.value||!e.value.length){var groupKeys=Object.keys(ctg);for(var i=0;i<groupKeys.length;i++){var key=groupKeys[i];var _layerInfo3=_this._byStamp[ctg[key]];_this._setOpacity(_layerInfo3,1)}}else{var selectedKeys={};for(var _i3=0;_i3<e.value.length;_i3++){selectedKeys[e.value[_i3]]=true}var _groupKeys2=Object.keys(ctg);for(var _i4=0;_i4<_groupKeys2.length;_i4++){var _key2=_groupKeys2[_i4];var _layerInfo4=_this._byStamp[ctg[_key2]];_this._setOpacity(_layerInfo4,selectedKeys[_groupKeys2[_i4]]?1:.2)}}};var selHandle=new crosstalk.SelectionHandle(ctGroup);selHandle.on("change",handleSelection);setTimeout(function(){handleFilter({value:filterHandle.filteredKeys});handleSelection({value:selHandle.value})},100)}if(!ctg[ctKey])ctg[ctKey]=[];ctg[ctKey].push(stamp)}if(!layerInfo.hidden)container.addLayer(layer);return oldLayer}},{key:"brush",value:function brush(bounds,extraInfo){var _this2=this;Object.keys(this._byCrosstalkGroup).forEach(function(ctGroupName){var ctg=_this2._byCrosstalkGroup[ctGroupName];var selection=[];Object.keys(ctg).forEach(function(ctKey){ctg[ctKey].forEach(function(stamp){var layerInfo=_this2._byStamp[stamp];if(layerInfo.layer.getLatLng){if(bounds.contains(layerInfo.layer.getLatLng())){selection.push(ctKey)}}})});new global.crosstalk.SelectionHandle(ctGroupName).set(selection,extraInfo)})}},{key:"unbrush",value:function unbrush(extraInfo){Object.keys(this._byCrosstalkGroup).forEach(function(ctGroupName){new global.crosstalk.SelectionHandle(ctGroupName).clear(extraInfo)})}},{key:"_setVisibility",value:function _setVisibility(layerInfo,visible){if(layerInfo.hidden^visible){return}else if(visible){layerInfo.container.addLayer(layerInfo.layer);layerInfo.hidden=false}else{layerInfo.container.removeLayer(layerInfo.layer);layerInfo.hidden=true}}},{key:"_setOpacity",value:function _setOpacity(layerInfo,opacity){if(layerInfo.layer.setOpacity){layerInfo.layer.setOpacity(opacity)}else if(layerInfo.layer.setStyle){layerInfo.layer.setStyle({opacity:opacity*layerInfo.layer.options.origOpacity,fillOpacity:opacity*layerInfo.layer.options.origFillOpacity})}}},{key:"getLayer",value:function getLayer(category,layerId){return this._byLayerId[this._layerIdKey(category,layerId)]}},{key:"removeLayer",value:function removeLayer(category,layerIds){var _this3=this;_jquery2.default.each((0,_util.asArray)(layerIds),function(i,layerId){var layer=_this3._byLayerId[_this3._layerIdKey(category,layerId)];if(layer){_this3._removeLayer(layer)}})}},{key:"clearLayers",value:function clearLayers(category){var _this4=this;var catTable=this._byCategory[category];if(!catTable){return false}var stamps=[];_jquery2.default.each(catTable,function(k,v){stamps.push(k)});_jquery2.default.each(stamps,function(i,stamp){_this4._removeLayer(stamp)})}},{key:"getLayerGroup",value:function getLayerGroup(group,ensureExists){var g=this._groupContainers[group];if(ensureExists&&!g){this._byGroup[group]=this._byGroup[group]||{};g=this._groupContainers[group]=_leaflet2.default.featureGroup();g.groupname=group;g.addTo(this._map)}return g}},{key:"getGroupNameFromLayerGroup",value:function getGroupNameFromLayerGroup(layerGroup){return layerGroup.groupname}},{key:"getVisibleGroups",value:function getVisibleGroups(){var _this5=this;var result=[];_jquery2.default.each(this._groupContainers,function(k,v){if(_this5._map.hasLayer(v)){result.push(k)}});return result}},{key:"getAllGroupNames",value:function getAllGroupNames(){var result=[];_jquery2.default.each(this._groupContainers,function(k,v){result.push(k)});return result}},{key:"clearGroup",value:function clearGroup(group){var _this6=this;var groupTable=this._byGroup[group];if(!groupTable){return false}var stamps=[];_jquery2.default.each(groupTable,function(k,v){stamps.push(k)});_jquery2.default.each(stamps,function(i,stamp){_this6._removeLayer(stamp)})}},{key:"clear",value:function clear(){function clearLayerGroup(key,layerGroup){layerGroup.clearLayers()}this._byGroup={};this._byCategory={};this._byLayerId={};this._byStamp={};this._byCrosstalkGroup={};_jquery2.default.each(this._categoryContainers,clearLayerGroup);this._categoryContainers={};_jquery2.default.each(this._groupContainers,clearLayerGroup);this._groupContainers={}}},{key:"_removeLayer",value:function _removeLayer(layer){var stamp=void 0;if(typeof layer==="string"){stamp=layer}else{stamp=_leaflet2.default.Util.stamp(layer)}var layerInfo=this._byStamp[stamp];if(!layerInfo){return false}layerInfo.container.removeLayer(stamp);if(typeof layerInfo.group==="string"){delete this._byGroup[layerInfo.group][stamp]}if(typeof layerInfo.layerId==="string"){delete this._byLayerId[this._layerIdKey(layerInfo.category,layerInfo.layerId)]}delete this._byCategory[layerInfo.category][stamp];delete this._byStamp[stamp];if(layerInfo.ctGroup){var ctGroup=this._byCrosstalkGroup[layerInfo.ctGroup];var layersForKey=ctGroup[layerInfo.ctKey];var idx=layersForKey?layersForKey.indexOf(stamp):-1;if(idx>=0){if(layersForKey.length===1){delete ctGroup[layerInfo.ctKey]}else{layersForKey.splice(idx,1)}}}}},{key:"_layerIdKey",value:function _layerIdKey(category,layerId){return category+"\n"+layerId}}]);return LayerManager}();exports.default=LayerManager}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./global/jquery":9,"./global/leaflet":10,"./util":17}],15:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _jquery=require("./global/jquery");var _jquery2=_interopRequireDefault(_jquery);var _leaflet=require("./global/leaflet");var _leaflet2=_interopRequireDefault(_leaflet);var _shiny=require("./global/shiny");var _shiny2=_interopRequireDefault(_shiny);var _htmlwidgets=require("./global/htmlwidgets");var _htmlwidgets2=_interopRequireDefault(_htmlwidgets);var _util=require("./util");var _crs_utils=require("./crs_utils");var _dataframe=require("./dataframe");var _dataframe2=_interopRequireDefault(_dataframe);var _clusterLayerStore=require("./cluster-layer-store");var _clusterLayerStore2=_interopRequireDefault(_clusterLayerStore);var _mipmapper=require("./mipmapper");var _mipmapper2=_interopRequireDefault(_mipmapper);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var methods={};exports.default=methods;function mouseHandler(mapId,layerId,group,eventName,extraInfo){return function(e){if(!_htmlwidgets2.default.shinyMode)return;var latLng=e.target.getLatLng?e.target.getLatLng():e.latlng;if(latLng){var latLngVal=_leaflet2.default.latLng(latLng);latLng={lat:latLngVal.lat,lng:latLngVal.lng}}var eventInfo=_jquery2.default.extend({id:layerId,".nonce":Math.random()},group!==null?{group:group}:null,latLng,extraInfo);_shiny2.default.onInputChange(mapId+"_"+eventName,eventInfo)}}methods.mouseHandler=mouseHandler;methods.clearGroup=function(group){var _this=this;_jquery2.default.each((0,_util.asArray)(group),function(i,v){_this.layerManager.clearGroup(v)})};methods.setView=function(center,zoom,options){this.setView(center,zoom,options)};methods.fitBounds=function(lat1,lng1,lat2,lng2,options){this.fitBounds([[lat1,lng1],[lat2,lng2]],options)};methods.flyTo=function(center,zoom,options){this.flyTo(center,zoom,options)};methods.flyToBounds=function(lat1,lng1,lat2,lng2,options){this.flyToBounds([[lat1,lng1],[lat2,lng2]],options)};methods.setMaxBounds=function(lat1,lng1,lat2,lng2){this.setMaxBounds([[lat1,lng1],[lat2,lng2]])};methods.addPopups=function(lat,lng,popup,layerId,group,options){var _this2=this;var df=(new _dataframe2.default).col("lat",lat).col("lng",lng).col("popup",popup).col("layerId",layerId).col("group",group).cbind(options);var _loop=function _loop(i){if(_jquery2.default.isNumeric(df.get(i,"lat"))&&_jquery2.default.isNumeric(df.get(i,"lng"))){(function(){var popup=_leaflet2.default.popup(df.get(i)).setLatLng([df.get(i,"lat"),df.get(i,"lng")]).setContent(df.get(i,"popup"));var thisId=df.get(i,"layerId");var thisGroup=df.get(i,"group");this.layerManager.addLayer(popup,"popup",thisId,thisGroup)}).call(_this2)}};for(var i=0;i<df.nrow();i++){_loop(i)}};methods.removePopup=function(layerId){this.layerManager.removeLayer("popup",layerId)};methods.clearPopups=function(){this.layerManager.clearLayers("popup")};methods.addTiles=function(urlTemplate,layerId,group,options){this.layerManager.addLayer(_leaflet2.default.tileLayer(urlTemplate,options),"tile",layerId,group)};methods.removeTiles=function(layerId){this.layerManager.removeLayer("tile",layerId)};methods.clearTiles=function(){this.layerManager.clearLayers("tile")};methods.addWMSTiles=function(baseUrl,layerId,group,options){if(options&&options.crs){options.crs=(0,_crs_utils.getCRS)(options.crs)}this.layerManager.addLayer(_leaflet2.default.tileLayer.wms(baseUrl,options),"tile",layerId,group)};function unpackStrings(iconset){if(!iconset){return iconset}if(typeof iconset.index==="undefined"){return iconset}iconset.data=(0,_util.asArray)(iconset.data);iconset.index=(0,_util.asArray)(iconset.index);return _jquery2.default.map(iconset.index,function(e,i){return iconset.data[e]})}function addMarkers(map,df,group,clusterOptions,clusterId,markerFunc){(function(){var _this3=this;var clusterGroup=this.layerManager.getLayer("cluster",clusterId),cluster=clusterOptions!==null;if(cluster&&!clusterGroup){clusterGroup=_leaflet2.default.markerClusterGroup.layerSupport(clusterOptions);if(clusterOptions.freezeAtZoom){var freezeAtZoom=clusterOptions.freezeAtZoom;delete clusterOptions.freezeAtZoom;clusterGroup.freezeAtZoom(freezeAtZoom)}clusterGroup.clusterLayerStore=new _clusterLayerStore2.default(clusterGroup)}var extraInfo=cluster?{clusterId:clusterId}:{};var _loop2=function _loop2(i){if(_jquery2.default.isNumeric(df.get(i,"lat"))&&_jquery2.default.isNumeric(df.get(i,"lng"))){(function(){var marker=markerFunc(df,i);var thisId=df.get(i,"layerId");var thisGroup=cluster?null:df.get(i,"group");if(cluster){clusterGroup.clusterLayerStore.add(marker,thisId)}else{this.layerManager.addLayer(marker,"marker",thisId,thisGroup,df.get(i,"ctGroup",true),df.get(i,"ctKey",true))}var popup=df.get(i,"popup");var popupOptions=df.get(i,"popupOptions");if(popup!==null){if(popupOptions!==null){marker.bindPopup(popup,popupOptions)}else{marker.bindPopup(popup)}}var label=df.get(i,"label");var labelOptions=df.get(i,"labelOptions");if(label!==null){if(labelOptions!==null){if(labelOptions.permanent){marker.bindTooltip(label,labelOptions).openTooltip()}else{marker.bindTooltip(label,labelOptions)}}else{marker.bindTooltip(label)}}marker.on("click",mouseHandler(this.id,thisId,thisGroup,"marker_click",extraInfo),this);marker.on("mouseover",mouseHandler(this.id,thisId,thisGroup,"marker_mouseover",extraInfo),this);marker.on("mouseout",mouseHandler(this.id,thisId,thisGroup,"marker_mouseout",extraInfo),this);marker.on("dragend",mouseHandler(this.id,thisId,thisGroup,"marker_dragend",extraInfo),this)}).call(_this3)}};for(var i=0;i<df.nrow();i++){_loop2(i)}if(cluster){this.layerManager.addLayer(clusterGroup,"cluster",clusterId,group)}}).call(map)}methods.addGenericMarkers=addMarkers;methods.addMarkers=function(lat,lng,icon,layerId,group,options,popup,popupOptions,clusterOptions,clusterId,label,labelOptions,crosstalkOptions){var icondf=void 0;var getIcon=void 0;if(icon){icon.iconUrl=unpackStrings(icon.iconUrl);icon.iconRetinaUrl=unpackStrings(icon.iconRetinaUrl);icon.shadowUrl=unpackStrings(icon.shadowUrl);icon.shadowRetinaUrl=unpackStrings(icon.shadowRetinaUrl);icondf=(new _dataframe2.default).cbind(icon);getIcon=function getIcon(i){var opts=icondf.get(i);if(!opts.iconUrl){return new _leaflet2.default.Icon.Default}if(opts.iconWidth){opts.iconSize=[opts.iconWidth,opts.iconHeight]}if(opts.shadowWidth){opts.shadowSize=[opts.shadowWidth,opts.shadowHeight]}if(opts.iconAnchorX){opts.iconAnchor=[opts.iconAnchorX,opts.iconAnchorY]}if(opts.shadowAnchorX){opts.shadowAnchor=[opts.shadowAnchorX,opts.shadowAnchorY]}if(opts.popupAnchorX){opts.popupAnchor=[opts.popupAnchorX,opts.popupAnchorY]}return new _leaflet2.default.Icon(opts)}}if(!(_jquery2.default.isEmptyObject(lat)||_jquery2.default.isEmptyObject(lng))||_jquery2.default.isNumeric(lat)&&_jquery2.default.isNumeric(lng)){var df=(new _dataframe2.default).col("lat",lat).col("lng",lng).col("layerId",layerId).col("group",group).col("popup",popup).col("popupOptions",popupOptions).col("label",label).col("labelOptions",labelOptions).cbind(options).cbind(crosstalkOptions||{});if(icon)icondf.effectiveLength=df.nrow();addMarkers(this,df,group,clusterOptions,clusterId,function(df,i){var options=df.get(i);if(icon)options.icon=getIcon(i);return _leaflet2.default.marker([df.get(i,"lat"),df.get(i,"lng")],options)})}};methods.addAwesomeMarkers=function(lat,lng,icon,layerId,group,options,popup,popupOptions,clusterOptions,clusterId,label,labelOptions,crosstalkOptions){var icondf=void 0;var getIcon=void 0;if(icon){icondf=(new _dataframe2.default).cbind(icon);getIcon=function getIcon(i){var opts=icondf.get(i);if(!opts){return new _leaflet2.default.AwesomeMarkers.icon}if(opts.squareMarker){opts.className="awesome-marker awesome-marker-square"}return new _leaflet2.default.AwesomeMarkers.icon(opts)}}if(!(_jquery2.default.isEmptyObject(lat)||_jquery2.default.isEmptyObject(lng))||_jquery2.default.isNumeric(lat)&&_jquery2.default.isNumeric(lng)){var df=(new _dataframe2.default).col("lat",lat).col("lng",lng).col("layerId",layerId).col("group",group).col("popup",popup).col("popupOptions",popupOptions).col("label",label).col("labelOptions",labelOptions).cbind(options).cbind(crosstalkOptions||{});if(icon)icondf.effectiveLength=df.nrow();addMarkers(this,df,group,clusterOptions,clusterId,function(df,i){var options=df.get(i);if(icon)options.icon=getIcon(i);return _leaflet2.default.marker([df.get(i,"lat"),df.get(i,"lng")],options)})}};function addLayers(map,category,df,layerFunc){var _loop3=function _loop3(i){(function(){var layer=layerFunc(df,i);if(!_jquery2.default.isEmptyObject(layer)){var thisId=df.get(i,"layerId");var thisGroup=df.get(i,"group");this.layerManager.addLayer(layer,category,thisId,thisGroup,df.get(i,"ctGroup",true),df.get(i,"ctKey",true));if(layer.bindPopup){var popup=df.get(i,"popup");var popupOptions=df.get(i,"popupOptions");if(popup!==null){if(popupOptions!==null){layer.bindPopup(popup,popupOptions)}else{layer.bindPopup(popup)}}}if(layer.bindTooltip){var label=df.get(i,"label");var labelOptions=df.get(i,"labelOptions");if(label!==null){if(labelOptions!==null){layer.bindTooltip(label,labelOptions)}else{layer.bindTooltip(label)}}}layer.on("click",mouseHandler(this.id,thisId,thisGroup,category+"_click"),this);layer.on("mouseover",mouseHandler(this.id,thisId,thisGroup,category+"_mouseover"),this);layer.on("mouseout",mouseHandler(this.id,thisId,thisGroup,category+"_mouseout"),this);var highlightStyle=df.get(i,"highlightOptions");if(!_jquery2.default.isEmptyObject(highlightStyle)){var defaultStyle={};_jquery2.default.each(highlightStyle,function(k,v){if(k!="bringToFront"&&k!="sendToBack"){if(df.get(i,k)){defaultStyle[k]=df.get(i,k)}}});layer.on("mouseover",function(e){this.setStyle(highlightStyle);if(highlightStyle.bringToFront){this.bringToFront()}});layer.on("mouseout",function(e){this.setStyle(defaultStyle);if(highlightStyle.sendToBack){this.bringToBack()}})}}}).call(map)};for(var i=0;i<df.nrow();i++){_loop3(i)}}methods.addGenericLayers=addLayers;methods.addCircles=function(lat,lng,radius,layerId,group,options,popup,popupOptions,label,labelOptions,highlightOptions,crosstalkOptions){if(!(_jquery2.default.isEmptyObject(lat)||_jquery2.default.isEmptyObject(lng))||_jquery2.default.isNumeric(lat)&&_jquery2.default.isNumeric(lng)){var df=(new _dataframe2.default).col("lat",lat).col("lng",lng).col("radius",radius).col("layerId",layerId).col("group",group).col("popup",popup).col("popupOptions",popupOptions).col("label",label).col("labelOptions",labelOptions).col("highlightOptions",highlightOptions).cbind(options).cbind(crosstalkOptions||{});addLayers(this,"shape",df,function(df,i){if(_jquery2.default.isNumeric(df.get(i,"lat"))&&_jquery2.default.isNumeric(df.get(i,"lng"))&&_jquery2.default.isNumeric(df.get(i,"radius"))){return _leaflet2.default.circle([df.get(i,"lat"),df.get(i,"lng")],df.get(i,"radius"),df.get(i))}else{return null}})}};methods.addCircleMarkers=function(lat,lng,radius,layerId,group,options,clusterOptions,clusterId,popup,popupOptions,label,labelOptions,crosstalkOptions){if(!(_jquery2.default.isEmptyObject(lat)||_jquery2.default.isEmptyObject(lng))||_jquery2.default.isNumeric(lat)&&_jquery2.default.isNumeric(lng)){var df=(new _dataframe2.default).col("lat",lat).col("lng",lng).col("radius",radius).col("layerId",layerId).col("group",group).col("popup",popup).col("popupOptions",popupOptions).col("label",label).col("labelOptions",labelOptions).cbind(crosstalkOptions||{}).cbind(options);addMarkers(this,df,group,clusterOptions,clusterId,function(df,i){return _leaflet2.default.circleMarker([df.get(i,"lat"),df.get(i,"lng")],df.get(i))})}};methods.addPolylines=function(polygons,layerId,group,options,popup,popupOptions,label,labelOptions,highlightOptions){if(polygons.length>0){var df=(new _dataframe2.default).col("shapes",polygons).col("layerId",layerId).col("group",group).col("popup",popup).col("popupOptions",popupOptions).col("label",label).col("labelOptions",labelOptions).col("highlightOptions",highlightOptions).cbind(options);addLayers(this,"shape",df,function(df,i){var shapes=df.get(i,"shapes");shapes=shapes.map(function(shape){return _htmlwidgets2.default.dataframeToD3(shape[0])});if(shapes.length>1){return _leaflet2.default.polyline(shapes,df.get(i))}else{return _leaflet2.default.polyline(shapes[0],df.get(i))}})}};methods.removeMarker=function(layerId){this.layerManager.removeLayer("marker",layerId)};methods.clearMarkers=function(){this.layerManager.clearLayers("marker")};methods.removeMarkerCluster=function(layerId){this.layerManager.removeLayer("cluster",layerId)};methods.removeMarkerFromCluster=function(layerId,clusterId){var cluster=this.layerManager.getLayer("cluster",clusterId);if(!cluster)return;cluster.clusterLayerStore.remove(layerId)};methods.clearMarkerClusters=function(){this.layerManager.clearLayers("cluster")};methods.removeShape=function(layerId){this.layerManager.removeLayer("shape",layerId)};methods.clearShapes=function(){this.layerManager.clearLayers("shape")};methods.addRectangles=function(lat1,lng1,lat2,lng2,layerId,group,options,popup,popupOptions,label,labelOptions,highlightOptions){var df=(new _dataframe2.default).col("lat1",lat1).col("lng1",lng1).col("lat2",lat2).col("lng2",lng2).col("layerId",layerId).col("group",group).col("popup",popup).col("popupOptions",popupOptions).col("label",label).col("labelOptions",labelOptions).col("highlightOptions",highlightOptions).cbind(options);addLayers(this,"shape",df,function(df,i){if(_jquery2.default.isNumeric(df.get(i,"lat1"))&&_jquery2.default.isNumeric(df.get(i,"lng1"))&&_jquery2.default.isNumeric(df.get(i,"lat2"))&&_jquery2.default.isNumeric(df.get(i,"lng2"))){return _leaflet2.default.rectangle([[df.get(i,"lat1"),df.get(i,"lng1")],[df.get(i,"lat2"),df.get(i,"lng2")]],df.get(i))}else{return null}})};methods.addPolygons=function(polygons,layerId,group,options,popup,popupOptions,label,labelOptions,highlightOptions){if(polygons.length>0){var df=(new _dataframe2.default).col("shapes",polygons).col("layerId",layerId).col("group",group).col("popup",popup).col("popupOptions",popupOptions).col("label",label).col("labelOptions",labelOptions).col("highlightOptions",highlightOptions).cbind(options);addLayers(this,"shape",df,function(df,i){var shapes=df.get(i,"shapes").map(function(polygon){return polygon.map(_htmlwidgets2.default.dataframeToD3)}).reduce(function(acc,val){return acc.concat(val)},[]);return _leaflet2.default.polygon(shapes,df.get(i))})}};methods.addGeoJSON=function(data,layerId,group,style){var self=this;if(typeof data==="string"){data=JSON.parse(data)}var globalStyle=_jquery2.default.extend({},style,data.style||{});var gjlayer=_leaflet2.default.geoJson(data,{style:function style(feature){if(feature.style||feature.properties.style){return _jquery2.default.extend({},globalStyle,feature.style,feature.properties.style)}else{return globalStyle}},onEachFeature:function onEachFeature(feature,layer){var extraInfo={featureId:feature.id,properties:feature.properties};var popup=feature.properties?feature.properties.popup:null;if(typeof popup!=="undefined"&&popup!==null)layer.bindPopup(popup);layer.on("click",mouseHandler(self.id,layerId,group,"geojson_click",extraInfo),this);layer.on("mouseover",mouseHandler(self.id,layerId,group,"geojson_mouseover",extraInfo),this);layer.on("mouseout",mouseHandler(self.id,layerId,group,"geojson_mouseout",extraInfo),this)}});this.layerManager.addLayer(gjlayer,"geojson",layerId,group)};methods.removeGeoJSON=function(layerId){this.layerManager.removeLayer("geojson",layerId)};methods.clearGeoJSON=function(){this.layerManager.clearLayers("geojson")};methods.addTopoJSON=function(data,layerId,group,style){var self=this;if(typeof data==="string"){data=JSON.parse(data)}var globalStyle=_jquery2.default.extend({},style,data.style||{});var gjlayer=_leaflet2.default.geoJson(null,{style:function style(feature){if(feature.style||feature.properties.style){return _jquery2.default.extend({},globalStyle,feature.style,feature.properties.style)}else{return globalStyle}},onEachFeature:function onEachFeature(feature,layer){var extraInfo={featureId:feature.id,properties:feature.properties};var popup=feature.properties.popup;if(typeof popup!=="undefined"&&popup!==null)layer.bindPopup(popup);layer.on("click",mouseHandler(self.id,layerId,group,"topojson_click",extraInfo),this);layer.on("mouseover",mouseHandler(self.id,layerId,group,"topojson_mouseover",extraInfo),this);layer.on("mouseout",mouseHandler(self.id,layerId,group,"topojson_mouseout",extraInfo),this)}});global.omnivore.topojson.parse(data,null,gjlayer);this.layerManager.addLayer(gjlayer,"topojson",layerId,group)};methods.removeTopoJSON=function(layerId){this.layerManager.removeLayer("topojson",layerId)};methods.clearTopoJSON=function(){this.layerManager.clearLayers("topojson")};methods.addControl=function(html,position,layerId,classes){function onAdd(map){var div=_leaflet2.default.DomUtil.create("div",classes);if(typeof layerId!=="undefined"&&layerId!==null){div.setAttribute("id",layerId)}this._div=div;if(window.Shiny&&_shiny2.default.initializeInputs){_shiny2.default.renderHtml(html,this._div);_shiny2.default.initializeInputs(this._div);_shiny2.default.bindAll(this._div)}else{this._div.innerHTML=html}return this._div}function onRemove(map){if(window.Shiny&&_shiny2.default.unbindAll){_shiny2.default.unbindAll(this._div)}}var Control=_leaflet2.default.Control.extend({options:{position:position},onAdd:onAdd,onRemove:onRemove});this.controls.add(new Control,layerId,html)};methods.addCustomControl=function(control,layerId){this.controls.add(control,layerId)};methods.removeControl=function(layerId){this.controls.remove(layerId)};methods.getControl=function(layerId){this.controls.get(layerId)};methods.clearControls=function(){this.controls.clear()};methods.addLegend=function(options){var legend=_leaflet2.default.control({position:options.position});var gradSpan=void 0;legend.onAdd=function(map){var div=_leaflet2.default.DomUtil.create("div",options.className),colors=options.colors,labels=options.labels,legendHTML="";if(options.type==="numeric"){var singleBinHeight=20;var vMargin=8;var tickWidth=4;var labelPadding=6;var singleBinPct=(options.extra.p_n-options.extra.p_1)/(labels.length-1);var totalHeight=1/singleBinPct*singleBinHeight+1;var tickOffset=singleBinHeight/singleBinPct*options.extra.p_1;gradSpan=(0,_jquery2.default)("<span/>").css({background:"linear-gradient("+colors+")",opacity:options.opacity,height:totalHeight+"px",width:"18px",display:"block","margin-top":vMargin+"px"});var leftDiv=(0,_jquery2.default)("<div/>").css("float","left"),rightDiv=(0,_jquery2.default)("<div/>").css("float","left");leftDiv.append(gradSpan);(0,_jquery2.default)(div).append(leftDiv).append(rightDiv).append((0,_jquery2.default)("<br>"));document.body.appendChild(div);var ns="http://www.w3.org/2000/svg";var svg=document.createElementNS(ns,"svg");rightDiv.append(svg);var g=document.createElementNS(ns,"g");(0,_jquery2.default)(g).attr("transform","translate(0, "+vMargin+")");svg.appendChild(g);var maxLblWidth=0;_jquery2.default.each(labels,function(i,label){var y=tickOffset+i*singleBinHeight+.5;var thisLabel=document.createElementNS(ns,"text");(0,_jquery2.default)(thisLabel).text(labels[i]).attr("y",y).attr("dx",labelPadding).attr("dy","0.5ex");g.appendChild(thisLabel);maxLblWidth=Math.max(maxLblWidth,thisLabel.getComputedTextLength());var thisTick=document.createElementNS(ns,"line");(0,_jquery2.default)(thisTick).attr("x1",0).attr("x2",tickWidth).attr("y1",y).attr("y2",y).attr("stroke-width",1);g.appendChild(thisTick)});(0,_jquery2.default)(svg).find("text").attr("dx",labelPadding+maxLblWidth).attr("text-anchor","end");(0,_jquery2.default)(svg).css({width:maxLblWidth+labelPadding+"px",height:totalHeight+vMargin*2+"px"});if(options.na_color&&_jquery2.default.inArray(options.na_label,labels)<0){(0,_jquery2.default)(div).append('<div><i style="'+"background:"+options.na_color+";opacity:"+options.opacity+";margin-right:"+labelPadding+"px"+';"></i>'+options.na_label+"</div>")}}else{if(options.na_color&&_jquery2.default.inArray(options.na_label,labels)<0){colors.push(options.na_color);labels.push(options.na_label)}for(var i=0;i<colors.length;i++){legendHTML+='<i style="background:'+colors[i]+";opacity:"+options.opacity+'"></i> '+labels[i]+"<br>"}div.innerHTML=legendHTML}if(options.title)(0,_jquery2.default)(div).prepend('<div style="margin-bottom:3px"><strong>'+options.title+"</strong></div>");return div};if(options.group){if(!options.layerId){options.layerId=_leaflet2.default.Util.stamp(legend)}var map=this;map.on("overlayadd",function(e){if(e.name===options.group){map.controls.add(legend,options.layerId)}});map.on("overlayremove",function(e){if(e.name===options.group){map.controls.remove(options.layerId)}});map.on("groupadd",function(e){if(e.name===options.group){map.controls.add(legend,options.layerId)}});map.on("groupremove",function(e){if(e.name===options.group){map.controls.remove(options.layerId)}})}this.controls.add(legend,options.layerId)};methods.addLayersControl=function(baseGroups,overlayGroups,options){var _this4=this;methods.removeLayersControl.call(this);var firstLayer=true;var base={};_jquery2.default.each((0,_util.asArray)(baseGroups),function(i,g){var layer=_this4.layerManager.getLayerGroup(g,true);if(layer){base[g]=layer;if(_this4.hasLayer(layer)){if(firstLayer){firstLayer=false}else{_this4.removeLayer(layer)}}}});var overlay={};_jquery2.default.each((0,_util.asArray)(overlayGroups),function(i,g){var layer=_this4.layerManager.getLayerGroup(g,true);if(layer){overlay[g]=layer}});this.currentLayersControl=_leaflet2.default.control.layers(base,overlay,options);this.addControl(this.currentLayersControl)};methods.removeLayersControl=function(){if(this.currentLayersControl){this.removeControl(this.currentLayersControl);this.currentLayersControl=null}};methods.addScaleBar=function(options){methods.removeScaleBar.call(this);var scaleBar=_leaflet2.default.control.scale(options).addTo(this);this.currentScaleBar=scaleBar};methods.removeScaleBar=function(){if(this.currentScaleBar){this.currentScaleBar.remove();this.currentScaleBar=null}};methods.hideGroup=function(group){var _this5=this;_jquery2.default.each((0,_util.asArray)(group),function(i,g){var layer=_this5.layerManager.getLayerGroup(g,true);if(layer){_this5.removeLayer(layer)}})};methods.showGroup=function(group){var _this6=this;_jquery2.default.each((0,_util.asArray)(group),function(i,g){var layer=_this6.layerManager.getLayerGroup(g,true);if(layer){_this6.addLayer(layer)}})};function setupShowHideGroupsOnZoom(map){if(map.leafletr._hasInitializedShowHideGroups){return}map.leafletr._hasInitializedShowHideGroups=true;function setVisibility(layer,visible,group){if(visible!==map.hasLayer(layer)){if(visible){map.addLayer(layer);map.fire("groupadd",{name:group,layer:layer})}else{map.removeLayer(layer);map.fire("groupremove",{name:group,layer:layer})}}}function showHideGroupsOnZoom(){if(!map.layerManager)return;var zoom=map.getZoom();map.layerManager.getAllGroupNames().forEach(function(group){var layer=map.layerManager.getLayerGroup(group,false);if(layer&&typeof layer.zoomLevels!=="undefined"){setVisibility(layer,layer.zoomLevels===true||layer.zoomLevels.indexOf(zoom)>=0,group)}})}map.showHideGroupsOnZoom=showHideGroupsOnZoom;map.on("zoomend",showHideGroupsOnZoom)}methods.setGroupOptions=function(group,options){var _this7=this;_jquery2.default.each((0,_util.asArray)(group),function(i,g){var layer=_this7.layerManager.getLayerGroup(g,true);if(typeof options.zoomLevels!=="undefined"&&options.zoomLevels!==null){layer.zoomLevels=(0,_util.asArray)(options.zoomLevels)}});setupShowHideGroupsOnZoom(this);this.showHideGroupsOnZoom()};methods.addRasterImage=function(uri,bounds,opacity,attribution,layerId,group){function degree2tile(lat,lng,zoom){var latRad=lat*Math.PI/180;var n=Math.pow(2,zoom);var x=(lng+180)/360*n;var y=(1-Math.log(Math.tan(latRad)+1/Math.cos(latRad))/Math.PI)/2*n;return{x:x,y:y}}function overlap(from,to,x,x1){if(arguments.length==3)x1=x;return x<to&&x1>=from}function getCanvasSmoothingProperty(ctx){var candidates=["imageSmoothingEnabled","mozImageSmoothingEnabled","webkitImageSmoothingEnabled","msImageSmoothingEnabled"];for(var i=0;i<candidates.length;i++){if(typeof ctx[candidates[i]]!=="undefined"){return candidates[i]}}return null}var imgData=null;var imgDataMipMapper=null;var w=null;var h=null;var imgDataCallbacks=[];function getImageData(callback){if(imgData!=null){setTimeout(function(){callback(imgData,w,h,imgDataMipMapper)},0)}else{imgDataCallbacks.push(callback)}}var img=new Image;img.onload=function(){w=img.width;h=img.height;var imgDataCanvas=document.createElement("canvas");imgDataCanvas.width=w;imgDataCanvas.height=h;imgDataCanvas.style.display="none";document.body.appendChild(imgDataCanvas);var imgDataCtx=imgDataCanvas.getContext("2d");imgDataCtx.drawImage(img,0,0);imgData=imgDataCtx.getImageData(0,0,w,h).data;imgDataMipMapper=new _mipmapper2.default(img);document.body.removeChild(imgDataCanvas);for(var i=0;i<imgDataCallbacks.length;i++){imgDataCallbacks[i](imgData,w,h,imgDataMipMapper)}imgDataCallbacks=[]};img.src=uri;var canvasTiles=_leaflet2.default.gridLayer({opacity:opacity,attribution:attribution,detectRetina:true,async:true});canvasTiles.createTile=function(tilePoint,done){var zoom=tilePoint.z;var canvas=_leaflet2.default.DomUtil.create("canvas");var error=void 0;var size=this.getTileSize();canvas.width=size.x;canvas.height=size.y;getImageData(function(imgData,w,h,mipmapper){try{var ctx=canvas.getContext("2d");var topLeft=degree2tile(bounds[0][0],bounds[0][1],zoom);var bottomRight=degree2tile(bounds[1][0],bounds[1][1],zoom);var extent={x:bottomRight.x-topLeft.x,y:bottomRight.y-topLeft.y};if(!overlap(tilePoint.x,tilePoint.x+1,topLeft.x,bottomRight.x))return;if(!overlap(tilePoint.y,tilePoint.y+1,topLeft.y,bottomRight.y))return;var imgRes={x:w/extent.x,y:h/extent.y};var smoothingProperty=getCanvasSmoothingProperty(ctx);if(smoothingProperty||imgRes.x>=256&&imgRes.y>=256){if(smoothingProperty){ctx[smoothingProperty]=imgRes.x>=256&&imgRes.y>=256}mipmapper.getBySize(extent.x*256,extent.y*256,function(mip){ctx.drawImage(mip,(topLeft.x-tilePoint.x)*256,(topLeft.y-tilePoint.y)*256,extent.x*256,extent.y*256)})}else{var sourceStart={x:Math.max(0,Math.floor((tilePoint.x-topLeft.x)*imgRes.x)),y:Math.max(0,Math.floor((tilePoint.y-topLeft.y)*imgRes.y))};var sourceEnd={x:Math.min(w,Math.ceil((tilePoint.x+1-topLeft.x)*imgRes.x)),y:Math.min(h,Math.ceil((tilePoint.y+1-topLeft.y)*imgRes.y))};var pixelSize={x:256/imgRes.x,y:256/imgRes.y};for(var row=sourceStart.y;row<sourceEnd.y;row++){for(var col=sourceStart.x;col<sourceEnd.x;col++){var i=(row*w+col)*4;var r=imgData[i];var g=imgData[i+1];var b=imgData[i+2];var a=imgData[i+3];ctx.fillStyle="rgba("+[r,g,b,a/255].join(",")+")";var pixelPos={x:(col/imgRes.x+topLeft.x-tilePoint.x)*256,y:(row/imgRes.y+topLeft.y-tilePoint.y)*256};ctx.fillRect(Math.round(pixelPos.x),Math.round(pixelPos.y),Math.round(pixelPos.x+pixelSize.x)-Math.round(pixelPos.x),Math.round(pixelPos.y+pixelSize.y)-Math.round(pixelPos.y))}}}}catch(e){error=e}finally{done(error,canvas)}});return canvas};this.layerManager.addLayer(canvasTiles,"image",layerId,group)};methods.removeImage=function(layerId){this.layerManager.removeLayer("image",layerId)};methods.clearImages=function(){this.layerManager.clearLayers("image")};methods.addMeasure=function(options){methods.removeMeasure.call(this);this.measureControl=_leaflet2.default.control.measure(options);this.addControl(this.measureControl)};methods.removeMeasure=function(){if(this.measureControl){this.removeControl(this.measureControl);this.measureControl=null}};methods.addSelect=function(ctGroup){var _this8=this;methods.removeSelect.call(this);this._selectButton=_leaflet2.default.easyButton({states:[{stateName:"select-inactive",icon:"ion-qr-scanner",title:"Make a selection",onClick:function onClick(btn,map){btn.state("select-active");_this8._locationFilter=new _leaflet2.default.LocationFilter2;if(ctGroup){var selectionHandle=new global.crosstalk.SelectionHandle(ctGroup);selectionHandle.on("change",function(e){if(e.sender!==selectionHandle){if(_this8._locationFilter){_this8._locationFilter.disable();btn.state("select-inactive")}}});var handler=function handler(e){_this8.layerManager.brush(_this8._locationFilter.getBounds(),{sender:selectionHandle})};_this8._locationFilter.on("enabled",handler);_this8._locationFilter.on("change",handler);_this8._locationFilter.on("disabled",function(){selectionHandle.close();_this8._locationFilter=null})}_this8._locationFilter.addTo(map)}},{stateName:"select-active",icon:"ion-close-round",title:"Dismiss selection",onClick:function onClick(btn,map){btn.state("select-inactive");_this8._locationFilter.disable();_this8.layerManager.unbrush()}}]});this._selectButton.addTo(this)};methods.removeSelect=function(){if(this._locationFilter){this._locationFilter.disable()}if(this._selectButton){this.removeControl(this._selectButton);this._selectButton=null}};methods.createMapPane=function(name,zIndex){this.createPane(name);this.getPane(name).style.zIndex=zIndex}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./cluster-layer-store":1,"./crs_utils":3,"./dataframe":4,"./global/htmlwidgets":8,"./global/jquery":9,"./global/leaflet":10,"./global/shiny":12,"./mipmapper":16,"./util":17}],16:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Mipmapper=function(){function Mipmapper(img){_classCallCheck(this,Mipmapper);this._layers=[img]}_createClass(Mipmapper,[{key:"getBySize",value:function getBySize(desiredWidth,desiredHeight,callback){var _this=this;var i=0;var lastImg=this._layers[0];var testNext=function testNext(){_this.getByIndex(i,function(img){if(!img||img.width<desiredWidth||img.height<desiredHeight){callback(lastImg);return}else{lastImg=img;i++;testNext();return}})};testNext()}},{key:"getByIndex",value:function getByIndex(i,callback){var _this2=this;if(this._layers[i]){callback(this._layers[i]);return}this.getByIndex(i-1,function(prevImg){if(!prevImg){callback(null);return}if(prevImg.width<2||prevImg.height<2){callback(null);return}_this2.reduce(prevImg,function(reducedImg){_this2._layers[i]=reducedImg;callback(reducedImg);return})})}},{key:"reduce",value:function reduce(img,callback){var imgDataCanvas=document.createElement("canvas");imgDataCanvas.width=Math.ceil(img.width/2);imgDataCanvas.height=Math.ceil(img.height/2);imgDataCanvas.style.display="none";document.body.appendChild(imgDataCanvas);try{var imgDataCtx=imgDataCanvas.getContext("2d");imgDataCtx.drawImage(img,0,0,img.width/2,img.height/2);callback(imgDataCanvas)}finally{document.body.removeChild(imgDataCanvas)}}}]);return Mipmapper}();exports.default=Mipmapper},{}],17:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.log=log;exports.recycle=recycle;exports.asArray=asArray;function log(message){if(console&&console.log)console.log(message)}function recycle(values,length,inPlace){if(length===0&&!inPlace)return[];if(!(values instanceof Array)){if(inPlace){throw new Error("Can't do in-place recycling of a non-Array value")}values=[values]}if(typeof length==="undefined")length=values.length;var dest=inPlace?values:[];var origLength=values.length;while(dest.length<length){dest.push(values[dest.length%origLength])}if(dest.length>length){dest.splice(length,dest.length-length)}return dest}function asArray(value){if(value instanceof Array)return value;else return[value]}},{}]},{},[13]);
